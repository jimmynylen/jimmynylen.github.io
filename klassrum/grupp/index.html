<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skapa slumpmässiga grupper</title>
    <!-- (Valfria) Ikonlänkar -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Google Fonts -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400&family=Source+Serif+Pro&display=swap">

    <style>
        /* ====== Grundinställningar ====== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        :root {
            --bg: #f4f4f4; /* ljusgrå */
            --white: #ffffff; /* vit */
            --primary: #40534C; /* dämpad grön/blå */
            --dark: #1A3636; /* mörk teal */
            --text: #644117; /* mörk brun */
            --subtle: #D6BD98; /* ljus beige */
            --effect: #677D6A; /* gråblå/grön */
            --placeholder: #B9AFA1; /* grå/beige  */
            --textarea: #FCF8F4; /* ljusbeige till rutor*/
            --extra_effect: #D98E04; /* mörk senapsgul */
            --extra_primary: #E0A030; /* lejongul */
            --extra_red: #A44434; /* bränd röd */
        }

        ::placeholder {
            color: var(--placeholder);
            opacity: 1;
            /* Firefox */
        }

        body {
            font-family: 'Source Serif Pro', serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
        }

        p {
            margin-top: 0;
            font-size: 15px;
            color: var(--text);
            background-color: var(--subtle);
            padding: 10px 20px;
            border-radius: 0 0 8px 8px;
        }

        .container {
            background-color: var(--white);
            max-width: 740px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px auto;
            position: relative;
        }

        .content {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
        }

        /* ====== Header ====== */
        h1 {
            font-family: 'Poppins', sans-serif;
            margin-top: 0px;
            font-size: 24px;
            color: var(--white);
            background-color: var(--primary);
            border-radius: 8px 8px 0 0;
            padding: 10px 20px;
            margin-bottom: 0px;
        }

        /* ====== Formulärstilar ====== */
        label {
            font-family: monospace;
            color: var(--primary);
            font-weight: normal;
            font-size: 14px;
            display: block;
            margin-top: 5px;
        }

        textarea,
        input[type="number"] {
            background-color: var(--textarea);
            border: 1px solid var(--effect);
            color: var(--dark);
            font-size: 13px;
            width: 100%;
            max-width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 5px;
            border-radius: 5px;
            box-sizing: border-box;
            resize: vertical;
        }

        button {
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            background-color: var(--dark);
            color: white;
            border: none;
            border-radius: 5px;
            width: 100%;
            /* Default för block-knappar */
            box-sizing: border-box;
            display: block;
            margin-top: 0px;
            padding: 10px 0;
        }

        button:hover {
            background-color: var(--effect);
        }

        .submit-button {
            margin-top: 10px;
        }

        #separator {
            border-top: 1px dashed var(--dark);
            margin: 20px 0;
        }

        /* ====== Resultatstilar ====== */

        .group {
            background-color: var(--effect);
            border: 1px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 100%;
        }

        .group:last-child {
            margin-bottom: 0;
        }

        .group h3 {
            margin-top: 0px;
            margin-bottom: 5px;
            color: var(--white);
            font-weight: normal;
            font-family: monospace;
            font-size: 14px;
        }

        .nameLabel {
            margin-top: 10px;
        }

        .students-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .student {
            background-color: var(--primary);
            padding: 8px 12px;
            border-radius: 4px;
            text-align: center;
            color: var(--white);
            font-family: monospace;
            font-size: 14px;
        }

        .students-container.odd .student:last-child {
            grid-column: 1 / -1;
        }

        /* ====== Kopieringsknapp ====== */
        #copyButton {
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            background-color: var(--extra_effect);
            border: 1px dashed var(--extra_red);
            color: white;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 20px;
            padding: 10px 0;
        }

        #copyButton:hover {
            background-color: var(--extra_primary);
        }

        /* ====== Kopieringsmeddelande ====== */
        #copyMessage {
            display: none;
            /* Döljs tills den behövs */
            margin-top: 5px;
            font-size: 14px;
            color: var(--dark);
            text-align: center;
        }

        /* Responsiv design */
        @media (max-width: 700px) {
            .container {
                padding: 20px;
            }

            .content {
                max-width: 100%;
            }

            h2 {
                font-size: 20px;
                padding: 8px 16px;
            }

            label {
                font-size: 14px;
            }

            textarea,
            input[type="number"],
            button,
            #copyButton {
                font-size: 15px;
                padding: 10px;
            }

            .students-container {
                grid-template-columns: 1fr;
            }

            .students-container.odd .student:last-child {
                grid-column: auto;
            }

            .group h3 {
                font-size: 16px;
            }

            .student {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="content">
            <h1>Skapa slumpmässiga grupper</h1>
            <p>
                Mata in dina elevers namn och eventuella taggar såsom kön eller gymnasieprogram. De fördelas jämnt i
                grupperna utifrån de taggar du skapat, så långt det är möjligt. Om ingen tagg anges kommer eleverna att
                fördelas helt slumpmässigt. Separera namnen med komma eller ny rad.
            </p>

            <form id="groupForm">
                <!-- Ruta för elevernas namn och kategorier -->
                <label for="students">
          Ange elevernas namn och eventuella taggar:
        </label>
                <textarea id="students" rows="6"
          placeholder="Helt slumpmässig fördelning: Anna, Bengt, Cecilia, o.s.v.&#10;Jämn fördelning mellan könen: Anna:F, Bengt:M, Cecilia:F, o.s.v.&#10;Jämn fördelning mellan programmen: Anna:EK, Bengt:SA, Cecilia:NA, o.s.v.&#10;&#10;Du kan även skapa helt egna taggar om du så önskar."></textarea>

                <label for="numGroups">Antal grupper:</label>
                <input type="number" id="numGroups" min="1" placeholder="Ange antal grupper" value="2" required />

                <label class="nameLabel" for="groupNames">
          Ange egna gruppnamn (valfritt):
        </label>
                <textarea id="groupNames" rows="3"
          placeholder="Använd gärna denna funktion för att även slumpa ut ämnesområde att arbeta med.&#10;Exempel: Socialism, Liberalism, Konservatism, o.s.v."></textarea>

                <label for="fixedGroups">
          Placera dessa elever i specifika grupper (valfritt):
        </label>
                <textarea id="fixedGroups" rows="3"
          placeholder="Använd kolon följt av en siffra för att placera en elev i den gruppen.&#10;Exempel: Anna:1, Bengt:1, Cecilia:2, o.s.v."></textarea>

                <button type="submit" class="submit-button">Skapa nya grupper</button>
            </form>

            <hr id="separator" />

            <!-- Resultatområdet används både för förhandsvisning av tomma grupper och för visning av genererade grupper -->
            <div id="result" aria-live="polite"></div>

            <button id="copyButton">Kopiera grupper till urklipp</button>
            <div id="copyMessage">Grupperna har kopierats!</div>
        </div>
    </div>

    <script>
        // ---------------------------
    // Hjälpfunktion: Slumpa om en array
    // ---------------------------
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // ---------------------------
    // Global flagga: Har grupper redan genererats?
    // ---------------------------
    let groupsGenerated = false;

    // ---------------------------
    // Visa förhandsgrupper (placeholder) – används om inga grupper är genererade än
    // ---------------------------
    function updateEmptyGroups() {
      const numGroupsInput = document.getElementById('numGroups');
      const resultDiv = document.getElementById('result');
      const numGroups = parseInt(numGroupsInput.value) || 0;
      let html = '';
      for (let i = 1; i <= numGroups; i++) {
        html += `
          <div class="group">
            <h3>Grupp ${i}</h3>
            <div class="students-container odd">
              <div class="student">?</div>
            </div>
          </div>
        `;
      }
      resultDiv.innerHTML = html;
    }

    // ---------------------------
    // Funktion som uppdaterar grupperna: Om de redan genererats så anropas den riktiga
    // gruppfunktionen, annars visas placeholder-grupper.
    // ---------------------------
    function updateGroupsPreview() {
      if (groupsGenerated) {
        createGroups();
      } else {
        updateEmptyGroups();
      }
    }

    // ---------------------------
    // Funktion som genererar riktiga grupper utifrån formulärets innehåll
    // ---------------------------
    function createGroups() {
      const studentsInput = document.getElementById('students').value.trim();
      const groupNamesInput = document.getElementById('groupNames').value.trim();
      const numGroups = parseInt(document.getElementById('numGroups').value);
      const fixedGroupsInput = document.getElementById('fixedGroups').value.trim();

      const resultDiv = document.getElementById('result');
      const copyButton = document.getElementById('copyButton');
      const copyMessage = document.getElementById('copyMessage');

      // Enkel validering
      if (!studentsInput || isNaN(numGroups) || numGroups < 1) {
        resultDiv.innerHTML = 'Vänligen fyll i alla obligatoriska fält korrekt.';
        return;
      }

      // Skapa array med elevnamn och eventuella kategorier
      let studentsLines = studentsInput.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== '');

      // Hantera specifika grupptilldelningar
      let fixedAssignments = {};
      if (fixedGroupsInput) {
        const fixedEntries = fixedGroupsInput.split(/[\n,]+/);
        for (let entry of fixedEntries) {
          if (entry.includes(':')) {
            const [student, groupStr] = entry.split(':').map(s => s.trim());
            const groupNum = parseInt(groupStr);
            if (student && !isNaN(groupNum) && groupNum >= 1 && groupNum <= numGroups) {
              fixedAssignments[student] = groupNum;
            }
          }
        }
      }

      // Filtrera bort elever med fasta grupper
      let unassignedStudents = studentsLines.filter(s => {
        let name = s.includes(':') ? s.split(':')[0].trim() : s;
        return !(name in fixedAssignments);
      });

      // Skapa en struktur: categories = { kategoriNamn: [elever...] }
      let categories = {};
      for (let line of unassignedStudents) {
        if (line.includes(':')) {
          let [namePart, categoryPart] = line.split(':').map(s => s.trim());
          if (!categories[categoryPart]) {
            categories[categoryPart] = [];
          }
          categories[categoryPart].push(namePart);
        } else {
          if (!categories["noCategory"]) {
            categories["noCategory"] = [];
          }
          categories["noCategory"].push(line);
        }
      }

      // Blanda slumpmässigt varje kategorilista
      for (let cat in categories) {
        shuffleArray(categories[cat]);
      }

      // Skapa datastruktur för grupper
      let groups = {};
      let categoryCounts = {}; // Håller koll på antalet elever per kategori i varje grupp
      for (let i = 1; i <= numGroups; i++) {
        groups[i] = [];
        categoryCounts[i] = {};
      }

      // Lägg in de fasta eleverna direkt i rätt grupp
      for (let student in fixedAssignments) {
        let groupNum = fixedAssignments[student];
        groups[groupNum].push(student);

        // Uppdatera kategoriCounts om eleven har en kategori
        let studentEntry = studentsLines.find(s => {
          if (s.includes(':')) {
            return s.split(':')[0].trim() === student;
          }
          return false;
        });
        if (studentEntry && studentEntry.includes(':')) {
          let category = studentEntry.split(':')[1].trim();
          if (!categoryCounts[groupNum][category]) {
            categoryCounts[groupNum][category] = 0;
          }
          categoryCounts[groupNum][category]++;
        }
      }

      // Räkna totala antalet elever
      const totalStudents = studentsLines.length;
      const baseSize = Math.floor(totalStudents / numGroups);
      const extra = totalStudents % numGroups;

      // Beräkna hur många elever som ska läggas i varje grupp, exklusive de fasta
      let targetSizes = {};
      for (let i = 1; i <= numGroups; i++) {
        let desired = baseSize + (i <= extra ? 1 : 0);
        targetSizes[i] = Math.max(desired - groups[i].length, 0);
      }

      // -------------------------------------------
      // Tilldela oassignerade elever med minst en per kategori
      // -------------------------------------------
      let catKeys = Object.keys(categories);
      // Sortera så att 'noCategory' hanteras sist
      catKeys.sort(key => key === "noCategory" ? 1 : 0);

      // För varje kategori (utom noCategory), tilldela minst en elev per grupp om möjligt
      for (let cat of catKeys) {
        if (cat === "noCategory") continue;
        let catArray = categories[cat];
        for (let i = 1; i <= numGroups; i++) {
          if (catArray.length === 0) break;
          if (!categoryCounts[i][cat] && targetSizes[i] > 0) {
            let student = catArray.shift();
            groups[i].push(student);
            targetSizes[i]--;
            categoryCounts[i][cat] = 1;
          }
        }
      }

      // Tilldela resterande elever per kategori
      for (let cat of catKeys) {
        if (cat === "noCategory") continue;
        let catArray = categories[cat];
        let groupIndex = 1;
        while (catArray.length > 0) {
          if (groupIndex > numGroups) groupIndex = 1;
          if (targetSizes[groupIndex] > 0) {
            let student = catArray.shift();
            groups[groupIndex].push(student);
            targetSizes[groupIndex]--;
            if (!categoryCounts[groupIndex][cat]) {
              categoryCounts[groupIndex][cat] = 0;
            }
            categoryCounts[groupIndex][cat]++;
          }
          groupIndex++;
        }
      }

      // Hantera 'noCategory'
      if (categories["noCategory"]) {
        let noCatArray = categories["noCategory"];
        shuffleArray(noCatArray);
        let groupIndex = 1;
        while (noCatArray.length > 0) {
          if (groupIndex > numGroups) groupIndex = 1;
          if (targetSizes[groupIndex] > 0) {
            let student = noCatArray.shift();
            groups[groupIndex].push(student);
            targetSizes[groupIndex]--;
          }
          groupIndex++;
        }
      }

      // -------------------------------------------
      // Döp grupperna (använder eventuella angivna namn)
      // -------------------------------------------
      let groupNames = [];
      if (groupNamesInput) {
        groupNames = groupNamesInput.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== '');
        shuffleArray(groupNames);
      }

      let usageCount = {};
      if (groupNames.length > 0) {
        for (let i = 1; i <= numGroups; i++) {
          let name = groupNames[(i - 1) % groupNames.length];
          usageCount[name] = (usageCount[name] || 0) + 1;
        }
      }

      let usageSoFar = {};
      let resultHTML = '';

      for (let i = 1; i <= numGroups; i++) {
        const groupStudents = groups[i];
        const isOdd = groupStudents.length % 2 !== 0;
        let groupTitle = `Grupp ${i}`; // fallback

        if (groupNames.length > 0) {
          let name = groupNames[(i - 1) % groupNames.length];
          usageSoFar[name] = (usageSoFar[name] || 0) + 1;
          groupTitle = (usageCount[name] > 1) ? name + " " + usageSoFar[name] : name;
        }

        resultHTML += `
          <div class="group">
            <h3>${groupTitle}</h3>
            <div class="students-container ${isOdd ? 'odd' : ''}">
        `;
        for (let student of groupStudents) {
          resultHTML += `<div class="student">${student}</div>`;
        }
        resultHTML += `</div></div>`;
      }

      // Visa de genererade grupperna
      resultDiv.innerHTML = resultHTML;
      copyMessage.style.display = 'none';
      copyButton.scrollIntoView({ behavior: 'smooth' });
    }

    // ---------------------------
    // Vid sidladdning och ändring av antal grupper: Uppdatera antingen med placeholders eller riktiga grupper
    // ---------------------------
    document.addEventListener('DOMContentLoaded', updateGroupsPreview);
    document.getElementById('numGroups').addEventListener('input', updateGroupsPreview);

    // ---------------------------
    // När formuläret skickas: Generera grupper och sätt flaggan att de har genererats
    // ---------------------------
    document.getElementById('groupForm').addEventListener('submit', function (e) {
      e.preventDefault();
      createGroups();
      groupsGenerated = true;
    });

    // ---------------------------
    // Kopiera grupper till urklipp
    // ---------------------------
    document.getElementById('copyButton').addEventListener('click', function () {
      const resultDiv = document.getElementById('result');
      const copyMessage = document.getElementById('copyMessage');

      let groupsText = '';
      const groupElements = resultDiv.getElementsByClassName('group');
      for (let groupElement of groupElements) {
        const groupTitle = groupElement.querySelector('h3').innerText;
        groupsText += groupTitle + '\n';
        const studentElements = groupElement.getElementsByClassName('student');
        for (let studentElement of studentElements) {
          groupsText += '- ' + studentElement.innerText + '\n';
        }
        groupsText += '\n';
      }

      navigator.clipboard.writeText(groupsText.trim()).then(function () {
        copyMessage.style.display = 'block';
        setTimeout(function () {
          copyMessage.style.display = 'none';
        }, 1000); // Dölj meddelandet efter 1 sekund
      }, function (err) {
        alert('Kunde inte kopiera grupperna: ', err);
      });
    });
    </script>
</body>

</html>